<!doctype>
<html>
<head>
    <title>Jimi</title>
    <link rel="stylesheet" href="styles.css"/>
    <script src="https://unpkg.com/alpinejs@3.14.5" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5/ansi_up.min.js"></script>
    <script src="wasm_exec.js"></script>
</head>
<body x-data="app">
<h1>&#127928; Jimi</h1>
<form class="controls">
    <div>
        <label>Tuning</label>
        <span class="strings">
            <select x-model="tuning[0]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select x-model="tuning[1]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select x-model="tuning[2]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select x-model="tuning[3]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select x-model="tuning[4]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
            <select x-model="tuning[5]">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>
        </span>
    </div>
    <div>
        <label>Key/root note</label>
        <select x-model="root">
            <option value="C">C</option>
            <option value="C#">C#</option>
            <option value="D">D</option>
            <option value="D#">D#</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="F#">F#</option>
            <option value="G">G</option>
            <option value="G#">G#</option>
            <option value="A">A</option>
            <option value="A#">A#</option>
            <option value="B">B</option>
        </select>
    </div>
    <div>
        <label>Pattern</label>
        <select x-model="pattern">
            <option value="custom">custom...</option>
            <option value="chromatic">chromatic</option>
            <option value="aeolian">aeolian</option>
            <option value="dorian">dorian</option>
            <option value="ionian">ionian</option>
            <option value="locrian">locrian</option>
            <option value="lydian">lydian</option>
            <option value="major">major</option>
            <option value="major-blues">major-blues</option>
            <option value="major-pentatonic">major-pentatonic</option>
            <option value="minor">minor</option>
            <option value="minor-blues">minor-blues</option>
            <option value="minor-pentatonic">minor-pentatonic</option>
            <option value="mixolydian">mixolydian</option>
            <option value="phrygian">phrygian</option>
            <option value="5th">5th</option>
            <option value="aug">aug</option>
            <option value="dim">dim</option>
            <option value="m7b5">m7b5</option>
            <option value="major-6th">major-6th</option>
            <option value="major-7th">major-7th</option>
            <option value="major-maj7">major-maj7</option>
            <option value="major-triad">major-triad</option>
            <option value="minor-6th">minor-6th</option>
            <option value="minor-7th">minor-7th</option>
            <option value="minor-maj7">minor-maj7</option>
            <option value="minor-triad">minor-triad</option>
            <option value="sus">sus</option>
            <option value="sus2">sus2</option>
            <option value="sus4">sus4</option>
        </select>
    </div>
    <div>
        <label>Display</label>
        <select x-model="dispIntervals">
            <option value="false">notes</option>
            <option value="true">intervals</option>
        </select>
    </div>
</form>
<span id="console" class="jimi"></span>
<script>
    console.log = (message) => {
        document.getElementById("console").innerHTML = (new AnsiUp()).ansi_to_html(message);
    };
    const app = {
        go: null,
        wasmModule: null,
        root: 'C',
        tuning: ['E', 'A', 'D', 'G', 'B', 'E'],
        pattern: 'chromatic',
        dispIntervals: 'false',
        init() {
            this.go = new Go();
            WebAssembly.instantiateStreaming(fetch("jimi.wasm"), this.go.importObject)
                .then((result) => {
                    this.wasmModule = result.module;
                    this.$watch('root', () => {
                        this.run()
                    });
                    this.$watch('tuning', () => {
                        this.run()
                    });
                    this.$watch('pattern', () => {
                        this.run()
                    });
                    this.$watch('dispIntervals', () => {
                        this.run()
                    });
                    this.run();
                });
        },
        run() {
            if (!this.wasmModule) {
                return;
            }
            if (this.pattern === 'custom') {
                this.pattern = window.prompt('Custom pattern\nEx: R-M3-P5-m7');
            }
            WebAssembly.instantiate(this.wasmModule, this.go.importObject)
                .then((instance) => {
                    this.go.argv = ['jimi', `-t=${this.tuning.join('')}`, `-r=${this.root}`, `-p=${this.pattern}`, `-i=${this.dispIntervals}`];
                    this.go.run(instance);
                });
        },
    };
</script>
</body>
</html>